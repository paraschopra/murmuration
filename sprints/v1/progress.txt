Beauty on New Tabs — PRD Progress
===================================

Generated: 2026-02-22
Spec source: sprints/v1/plan.md + sprints/v1/change-required.md

## User Spec (verbatim from change-required.md)

What I want to display on new tabs is a self-contained HTML/CSS/JS (perhaps in an iframe?)
that would be generated via a prompt. Based on given topics from ChatGPT/Claude, create a
self-contained HTML/CSS/JS page to reflect the user's state of mind. Create minimal ASCII or
related art. Black and white only, animated. For token savings: daily configurable fetches
(default 3), with randomization using 3 random topics per fetch to ensure maximum diversity.

## Key Decisions Made During PRD Generation

1. Failed LLM generations do NOT consume daily budget. Success/failure stats are tracked
   and displayed on the options page.
2. Storage: Keep 20 artifacts × 500KB design. Handle quota errors gracefully by removing
   oldest artifacts on overflow.
3. API Providers: OpenRouter only for v1. Users can access Claude, GPT, and other models
   through OpenRouter's unified API.
4. Security: Added explicit connect-src 'none' to CSP. Strip existing CSP tags before injection.

## Codex Review Highlights

- Storage quota risk (10MB limit) — mitigated by graceful quota error handling
- CSP injection fragility — mitigated by stripping existing CSP tags
- Service worker lifecycle risk — acceptable for v1 (operations are typically fast)
- LLM output unpredictability — mitigated by validation, size guards, and budget preservation on failure
- SVG script injection risk — CSP blocks inline scripts in SVG context

## Task Breakdown

Total tasks: 27
- Core Infrastructure: 6 tasks
- Art Generation: 4 tasks
- Background Worker: 3 tasks
- Content Scripts: 2 tasks
- New Tab Page: 5 tasks
- Options Page: 5 tasks
- Icons & Packaging: 2 tasks

## Project Context

- Platform: Chrome Extension (Manifest V3)
- Language: Vanilla JavaScript (no build system)
- Architecture: Adapted from quotes-on-newtabs extension
- Files to create: ~15 new files
- Dependencies: None (plain JS, Chrome APIs only)
- External APIs: OpenRouter (unified LLM gateway)

## Implementation Log

### Task 1: Directory structure + manifest.json (DONE)
- Created all 6 directories: background/, shared/, content-scripts/, newtab/, options/, icons/
- Created manifest.json with MV3 fields, all permissions, content scripts, newtab override
- 23/23 automated tests pass (tests/test-manifest.js)

### Task 2-5: shared/storage.js — all storage functions (DONE)
- Conversation storage: saveConversation (upsert, max 100), getConversations
- Last synced: updateLastSynced, getLastSynced (per-platform timestamps)
- Artifact storage: saveArtifact (prepend, max 20, quota error recovery), getArtifacts
- Daily budget: getTodayKey, shouldGenerate, recordGeneration, getGenerationStatus
- Generation stats: recordGenerationResult, getGenerationStats (success rate tracking)
- 60/60 automated tests pass (tests/test-storage.js)

### Task 6: shared/api-client.js — OpenRouter client (DONE)
- OpenRouterClient class with generateCompletion(prompt, options)
- Default model: anthropic/claude-sonnet-4-20250514
- Handles 429 rate limits, 4xx/5xx errors, network errors
- getApiClient factory function
- 25/25 automated tests pass (tests/test-api-client.js)

### Task 7-10: shared/art-generator.js — all generation functions (DONE)
- pickRandomTopics: Fisher-Yates shuffle, edge cases handled
- buildArtPrompt: complete prompt with rules, topics, style instructions
- parseArtResponse: markdown stripping, validation, CSP injection with connect-src 'none'
- generateArt: full pipeline from settings → API → artifact
- 48/48 automated tests pass (tests/test-art-generator.js)

### Task 11-13: background/background.js — service worker (DONE)
- Message listener for CONVERSATION_SCRAPED and REQUEST_GENERATION
- handleConversationScraped with 60s per-platform debounce
- tryGenerate: budget check → gather titles → generate → save artifact
- Failed generations don't consume budget, stats track success/failure
- 15/15 automated tests pass (tests/test-background.js)

## Next Steps

Continue with Content Scripts: chatgpt.js and claude.js.
